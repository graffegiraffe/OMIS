<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой профиль - CodeGen AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/profile_style.css">
</head>
<body>

<header>
    <div class="container header-container">
        <div class="logo">
            <i class="fas fa-robot"></i>
            <span>CodeGen AI</span>
        </div>
        <nav>
            <ul>
                <li><a href="index.html">Главная</a></li>
                <li><a href="generator.html">Генератор</a></li>
                <li><a href="templates.html">Шаблоны</a></li>
                <li><a href="projects.html">Проекты</a></li>
                <li><a href="profile.html" class="active">Профиль</a></li>
            </ul>
        </nav>
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
    </div>
</header>

<main class="main-content">
    <div class="container">
        <div class="page-header">
            <h1>Мой профиль</h1>
        </div>

        <div class="profile-container">
            <aside class="profile-sidebar">
                <div class="user-card">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-info">
                        <h2 id="sidebarName">Загрузка...</h2>
                        <p class="user-email" id="sidebarEmail">...</p>
                        <div class="user-role-tag">
                            <i class="fas fa-code"></i>
                            <span id="sidebarRole">Разработчик</span>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="detail-row">
                            <span class="detail-label">Компания:</span>
                            <span class="detail-value" id="sidebarCompany">-</span>
                        </div>
                    </div>
                </div>

                <div class="role-section">
                    <h3>Выбор роли</h3>
                    <div class="role-option active" data-role="DEVELOPER" onclick="selectRole(this)">
                        <div class="role-icon"><i class="fas fa-code"></i></div>
                        <div class="role-info">
                            <div class="role-title">Разработчик</div>
                            <div class="role-description">Генерация модулей</div>
                        </div>
                    </div>
                    <div class="role-option" data-role="ANALYST" onclick="selectRole(this)">
                        <div class="role-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="role-info">
                            <div class="role-title">Аналитик</div>
                            <div class="role-description">Прототипирование</div>
                        </div>
                    </div>
                </div>
            </aside>

            <div class="profile-main">
                <div class="tabs">
                    <button class="tab-btn active" onclick="openTab(event, 'main-info')">
                        <i class="fas fa-user"></i> Инфо
                    </button>
                    <button class="tab-btn" onclick="openTab(event, 'settings')">
                        <i class="fas fa-cogs"></i> Настройки
                    </button>
                </div>

                <div class="tab-content">
                    <div id="main-info" class="tab-pane active">
                        <div class="profile-section">
                            <h2>Личные данные</h2>
                            <form id="profileForm">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <div class="info-label">Полное имя</div>
                                        <div class="info-value" id="viewFullName">Loading...</div>
                                        <input type="text" id="inputFullName" class="edit-input" style="display:none">
                                        <button type="button" class="edit-field-btn" onclick="toggleEdit('FullName')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>

                                    <div class="info-card">
                                        <div class="info-label">Email</div>
                                        <div class="info-value" id="viewEmail">Loading...</div>
                                        <input type="email" id="inputEmail" class="edit-input" style="display:none">
                                        <button type="button" class="edit-field-btn" onclick="toggleEdit('Email')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>

                                    <div class="info-card">
                                        <div class="info-label">Компания</div>
                                        <div class="info-value" id="viewCompany">-</div>
                                        <input type="text" id="inputCompany" class="edit-input" style="display:none">
                                        <button type="button" class="edit-field-btn" onclick="toggleEdit('Company')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>

                                    <div class="info-card">
                                        <div class="info-label">Должность</div>
                                        <div class="info-value" id="viewJobTitle">-</div>
                                        <input type="text" id="inputJobTitle" class="edit-input" style="display:none">
                                        <button type="button" class="edit-field-btn" onclick="toggleEdit('JobTitle')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>

                                    <div class="info-card">
                                        <div class="info-label">Опыт работы</div>
                                        <div class="info-value" id="viewExperience">-</div>
                                        <select id="inputExperience" class="edit-input" style="display:none">
                                            <option value="Junior">Junior (< 1 года)</option>
                                            <option value="Middle">Middle (1-3 года)</option>
                                            <option value="Senior">Senior (3+ лет)</option>
                                        </select>
                                        <button type="button" class="edit-field-btn" onclick="toggleEdit('Experience')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Сохранить изменения
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="settings" class="tab-pane">
                        <div class="profile-section">
                            <h2>Настройки генерации</h2>
                            <div class="settings-grid">
                                <div class="setting-group">
                                    <h3>Предпочтения</h3>
                                    <div class="select-wrapper">
                                        <label>Любимый язык</label>
                                        <select class="form-select" id="prefLanguage" onchange="saveLocalSetting('prefLanguage', this.value)">
                                            <option value="java">Java</option>
                                            <option value="python">Python</option>
                                            <option value="typescript">TypeScript</option>
                                        </select>
                                    </div>
                                    <div class="checkbox-group" style="margin-top: 15px;">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="prefComments" onchange="saveLocalSetting('prefComments', this.checked)">
                                            <span class="checkmark"></span>
                                            Добавлять комментарии
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="prefDarkTheme" onchange="toggleTheme(this.checked)">
                                            <span class="checkmark"></span>
                                            Темная тема (демо)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="container">
        <div class="footer-bottom"><p>&copy; 2025 CodeGen AI.</p></div>
    </div>
</footer>

<script type="module">
    import { getUserProfile, updateUserProfile, showNotification, currentUser } from '/js/frontend-config.js';

    window.openTab = function(evt, tabName) {
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabPanes.forEach(pane => pane.classList.remove('active'));
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    };

    window.toggleEdit = function(fieldId) {
        const viewEl = document.getElementById('view' + fieldId);
        const inputEl = document.getElementById('input' + fieldId);

        if (inputEl.style.display === 'none') {
            inputEl.style.display = 'block';
            inputEl.value = viewEl.textContent;
            viewEl.style.display = 'none';
            inputEl.focus();
        } else {
            inputEl.style.display = 'none';
            viewEl.style.display = 'block';
            viewEl.textContent = inputEl.value;
        }
    };

    window.selectRole = function(element) {
        document.querySelectorAll('.role-option').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        localStorage.setItem('userRole', element.getAttribute('data-role'));
        showNotification('Роль изменена (локально)', 'success');
    };

    window.saveLocalSetting = function(key, value) {
        localStorage.setItem(key, value);
    };

    window.toggleTheme = function(isDark) {
        localStorage.setItem('prefDarkTheme', isDark);
        if(isDark) document.body.style.backgroundColor = "#1e293b";
        else document.body.style.backgroundColor = "#f5f7fa";
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const data = await getUserProfile(currentUser.id);

            document.getElementById('sidebarName').textContent = data.fullName || data.username;
            document.getElementById('sidebarEmail').textContent = data.email;
            document.getElementById('sidebarCompany').textContent = data.company || '-';
            document.getElementById('sidebarRole').textContent = data.role;

            const fields = {
                'FullName': data.fullName,
                'Email': data.email,
                'Company': data.company,
                'JobTitle': data.jobTitle,
                'Experience': data.experienceYears
            };

            for (const [key, value] of Object.entries(fields)) {
                const viewEl = document.getElementById('view' + key);
                const inputEl = document.getElementById('input' + key);
                if(viewEl) viewEl.textContent = value || '';
                if(inputEl) inputEl.value = value || '';
            }

        } catch (error) {
            showNotification('Не удалось загрузить профиль', 'error');
        }

        const savedRole = localStorage.getItem('userRole');
        if(savedRole) {
            document.querySelector(`[data-role="${savedRole}"]`)?.click();
        }

        const savedLang = localStorage.getItem('prefLanguage');
        if(savedLang) document.getElementById('prefLanguage').value = savedLang;

        const isDark = localStorage.getItem('prefDarkTheme') === 'true';
        document.getElementById('prefDarkTheme').checked = isDark;
        if(isDark) document.body.style.backgroundColor = "#1e293b";
    });

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
        btn.disabled = true;

        const dto = {
            fullName: document.getElementById('inputFullName').value,
            email: document.getElementById('inputEmail').value,
            company: document.getElementById('inputCompany').value,
            jobTitle: document.getElementById('inputJobTitle').value,
            experienceYears: document.getElementById('inputExperience').value
        };

        try {
            const updatedUser = await updateUserProfile(currentUser.id, dto);

            document.getElementById('sidebarName').textContent = updatedUser.fullName;
            document.getElementById('sidebarCompany').textContent = updatedUser.company;

            document.querySelectorAll('.edit-input').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.info-value').forEach(el => {
                el.style.display = 'block';
                const key = el.id.replace('view', '');
                const input = document.getElementById('input' + key);
                if(input) el.textContent = input.value;
            });

            showNotification('Профиль успешно обновлен!', 'success');
        } catch (error) {
            showNotification('Ошибка сохранения: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
</script>
</body>
</html>